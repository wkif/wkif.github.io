{"title":"微信小程序云开发实现图片的上传、存储、访问","uid":"f5218906270dc804bb69eb4b82ceca1a","slug":"微信小程序云开发实现图片的上传、存储、访问","date":"2021-04-10T13:36:00.000Z","updated":"2022-04-24T08:02:42.189Z","comments":true,"path":"api/articles/微信小程序云开发实现图片的上传、存储、访问.json","keywords":null,"cover":"https://cdn.jsdelivr.net/gh/wkif/imgforTeachingDemo/202203310008758.jpg","content":"<p>我们在进行项目开发时，经常需要处理用户上传的图片，如果用传统的后端开发，处理起来是比较繁琐的。微信小程序云开发提供了一系列API供开发者完成想要的效果。<br>下面我们要实现用户图片的上传、存储及访问。</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&lt;button type&#x3D;&quot;primary&quot; bindtap&#x3D;&quot;upImg&quot;&gt;上传图片&lt;&#x2F;button&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n<p>因为只是演示功能，我们用一个按钮实现点击事件的产生。<br>首先我们用到的第一个API就是wx.chooseImage<br>官方文档介绍:</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/wkif/ImageHosting/video/20210410213807.png\"></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">upImg()&#123;\n   var that &#x3D; this;\n   wx.chooseImage(&#123;\n     count: 1,\n     success(res)&#123;\n       console.log(res);\n     &#125;\n   &#125;)\n &#125;,<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>然后我们试着选中一个图片，然后看控制台的输出内容。<br><img src=\"https://cdn.jsdelivr.net/gh/wkif/ImageHosting/video/20210410213841.png\"><br><strong>这个tempFilePaths是我们需要的数据。</strong><br>接下来我们使用第二个API，<strong>wx.cloud.uploadFile</strong><br>官方文档介绍：</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/wkif/ImageHosting/video/20210410213855.png\"></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">upImg()&#123;\n   var that &#x3D; this;\n   wx.chooseImage(&#123;\n     count: 1,\n     success(res)&#123;\n       console.log(res);\n       wx.cloud.uploadFile(&#123;\n         cloudPath:&#39;test&#x2F;&#39; + Math.floor(Math.random()*1000000),\n         filePath:res.tempFilePaths[0],\n         success(res)&#123;\n           console.log(&quot;成功&quot;,res);\n         &#125;\n       &#125;)\n     &#125;\n   &#125;)\n &#125;,<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>wx.chooseImage里面其实没有什么我们需要填写的参数，直接使用就行。但是wx.cloud.uploadFile很明显需要我们填写cloudPath和filePath，这个cloudPath其实就是我们要在云存储中存放的位置，可以新建一个文件夹，也可以直接往里堆。我是新建了一个名为test的文件夹并且在后面拼接了一个很多位的随机数，避免重复。<br>filePath就是我们上文提到的需要的数据，即wx.chooseImage的返回值中的tempFilePaths。<br>然后我们现在再点击一下按钮，看一下wx.cloud.uploadFile的回调会给我们返回一个什么样的值。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/wkif/ImageHosting/video/20210410213953.png\"></p>\n<p>fileID和statusCode<br>fileID就是在云存储中的链接，可以直接在客户端访问到。<br>statusCode是一个状态码，可以用来判断操作是否成功。</p>\n<p>我们现在试一下fileID能不能直接在WXML中通过Image组件访问到</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&lt;image src&#x3D;&quot;cloud:&#x2F;&#x2F;creator-xcq6k.6372-creator-xcq6k-1301361703&#x2F;test&#x2F;461783&quot;&gt;&lt;&#x2F;image&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n\n<p>没有问题，是可以直接访问的。<br>但是这个<strong>fileID</strong>仅仅只是在客户端可以被访问到，在一些业务场景下是不够的。<br>下面这个API可以把<strong>fileID</strong>转化为<strong>https</strong>的<strong>url</strong>地址，供全网访问。<br><strong>wx.cloud.getTempFileURL</strong><br>官方文档介绍：</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/wkif/ImageHosting/video/20210410214020.png\"></p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">upImg()&#123;\n  var that &#x3D; this;\n  wx.chooseImage(&#123;\n    count: 1,\n    success(res)&#123;\n      console.log(res);\n      wx.cloud.uploadFile(&#123;\n        cloudPath:&#39;test&#x2F;&#39; + Math.floor(Math.random()*1000000),\n        filePath:res.tempFilePaths[0],\n        success(res)&#123;\n          console.log(&quot;成功&quot;,res);\n          wx.cloud.getTempFileURL(&#123;\n            fileList:[res.fileID],\n            success(res)&#123;\n              console.log(res);\n            &#125;\n          &#125;)\n        &#125;\n      &#125;)\n    &#125;\n  &#125;)\n&#125;,<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/wkif/ImageHosting/video/20210410214044.png\"></p>\n<p>这里的<strong>tempFileURL</strong>就是我们需要的<strong>url</strong>。<br>复制一下，打开任意一个浏览器，粘贴到地址栏，就会弹出下载的弹窗</p>\n<p>下载了以后，因为没有后缀名所以是无法直接打开的，可以直接在后面填上.png或者.jpg的后缀。</p>\n<p>其实这里我推荐在当初填云存储的图片路径的时候，即<strong>cloudPath</strong>，就把图片的后缀加上，<strong>可以通过正则表达式获取真实的图片后缀，也可以人为的在后面手动拼接后缀</strong>，都没有问题。<br>如果路径上有图片的后缀的话，其实就可以直接在网页上浏览图片了，当然也可以下载。<br><img src=\"https://cdn.jsdelivr.net/gh/wkif/ImageHosting/video/20210410214113.png\"></p>\n<p>转载：</p>\n<p><a href=\"https://blog.csdn.net/m0_46171043/article/details/109653738\">微信小程序云开发实现图片的上传、存储、访问</a></p>\n","text":"我们在进行项目开发时，经常需要处理用户上传的图片，如果用传统的后端开发，处理起来是比较繁琐的。微信小程序云开发提供了一系列API供开发者完成想要的效果。下面我们要实现用户图片的上传、存储及访问。 &lt;button type&#x3D;&quot;primary&quot; b...","link":"","photos":[],"count_time":{"symbolsCount":"2.4k","symbolsTime":"2 mins."},"categories":[{"name":"学习笔记","slug":"学习笔记","count":27,"path":"api/categories/学习笔记.json"}],"tags":[{"name":"微信小程序","slug":"微信小程序","count":4,"path":"api/tags/微信小程序.json"}],"toc":"","author":{"name":"kif","slug":"blog-author","avatar":"https://kifimg.oss-cn-beijing.aliyuncs.com/imgforteachingdemo/20201127203438.png","link":"/","description":"时间再拉长一点，让我有时间收拾一下心情","socials":{"github":"https://github.com/wkif","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/qq_54739682?type=blog","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"后端框架学习-Django","uid":"1c5e4adfa32051d3ce39d99767de062e","slug":"后端框架学习-Django","date":"2021-05-05T14:16:00.000Z","updated":"2022-03-30T16:04:59.245Z","comments":true,"path":"api/articles/后端框架学习-Django.json","keywords":null,"cover":"https://kifimg.oss-cn-beijing.aliyuncs.com/imgforhexo/882690e66cdd6486c7ced449245fe620.jpg","text":"基本介绍Django 是一个由 Python 编写的一个开放源代码的 Web 应用框架。 使用 Django，只要很少的代码，Python 的程序开发人员就可以轻松地完成一个正式网站所需要的大部分内容，并进一步开发出全功能的 Web 服务 Django 本身基于 MVC 模型，即...","link":"","photos":[],"count_time":{"symbolsCount":"31k","symbolsTime":"28 mins."},"categories":[{"name":"学习笔记","slug":"学习笔记","count":27,"path":"api/categories/学习笔记.json"}],"tags":[{"name":"Django","slug":"Django","count":1,"path":"api/tags/Django.json"},{"name":"Python","slug":"Python","count":1,"path":"api/tags/Python.json"}],"author":{"name":"kif","slug":"blog-author","avatar":"https://kifimg.oss-cn-beijing.aliyuncs.com/imgforteachingdemo/20201127203438.png","link":"/","description":"时间再拉长一点，让我有时间收拾一下心情","socials":{"github":"https://github.com/wkif","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/qq_54739682?type=blog","juejin":"","customs":{}}}},"next_post":{"title":"微信小程序开发笔记","uid":"3e7ce6d43f68f0f7c89b0717b8394e60","slug":"微信小程序开发笔记","date":"2021-01-16T15:17:00.000Z","updated":"2022-03-30T16:08:25.809Z","comments":true,"path":"api/articles/微信小程序开发笔记.json","keywords":null,"cover":"https://cdn.jsdelivr.net/gh/wkif/imgforTeachingDemo/202203310008758.jpg","text":"1.跳转方式&#x2F;&#x2F;只能跳转到tabBar配置页面 wx.switchTab(&#123; url: &#39;&#x2F;pages&#x2F;index&#x2F;index&#39;, &#125;); &#x2F;&#x2F;返回上一级页面（delta：返...","link":"","photos":[],"count_time":{"symbolsCount":564,"symbolsTime":"1 mins."},"categories":[{"name":"学习笔记","slug":"学习笔记","count":27,"path":"api/categories/学习笔记.json"}],"tags":[{"name":"微信小程序","slug":"微信小程序","count":4,"path":"api/tags/微信小程序.json"}],"author":{"name":"kif","slug":"blog-author","avatar":"https://kifimg.oss-cn-beijing.aliyuncs.com/imgforteachingdemo/20201127203438.png","link":"/","description":"时间再拉长一点，让我有时间收拾一下心情","socials":{"github":"https://github.com/wkif","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/qq_54739682?type=blog","juejin":"","customs":{}}}}}